---
title: "Dataset Description and PCA Analysis"
author: "Your Name"
output:
  pdf_document:
    toc: true
    toc_depth: 3

date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.height = '80%', out.width = '80%', fig.align = "center", comment = "#>")
```

```{r}
# Load necessary libraries
library(ggplot2)   # For data visualization
library(readr)     # For reading datasets
library(lattice)   # For lattice-based visualizations
library(reshape2)  # For reshaping data
library(dplyr)     # For data manipulation
library(pander)
library(knitr)
library(gridExtra)
```

\newpage
# 1. Dataset Description

## 1.1 Overview
The **Online Shoppers Purchasing Intention Dataset** is sourced from the **UCI Machine Learning Repository** and provides valuable insights into online shopping behavior. This dataset tracks user interactions on an e-commerce website, with the primary goal of predicting whether a shopper will make a purchase during their visit.

It includes features such as the number of pages visited, time spent on various types of pages, bounce rates, and exit rates. Additionally, the dataset captures demographic information about the shoppers, such as whether they are new or returning visitors. The target variable indicates whether the shopper made a purchase, making the dataset a valuable resource for understanding and modeling purchasing behavior.

The original dataset contains **12,330 records** and **18 features**, including both numerical and categorical variables. For our analysis, we've taken a subset of the original dataset which contains **2,000 records** and **18 features**. 

## 1.2 Features
Below is a table representation with all the key features:

| **Feature Name**        | **Type**     | **Description**                                                   |
|-------------------|-----------------|------------------------------------|
| Administrative          | Quantitative | Number of administrative pages visited                            |
| AdministrativeDuration  | Quantitative | Time spent on administrative pages in seconds                     |
| Informational           | Quantitative | Number of informational pages visited                             |
| InformationalDuration   | Quantitative | Time spent on informational pages in seconds                      |
| ProductRelated          | Quantitative | Number of product-related pages visited                           |
| ProductRelatedDuration  | Quantitative | Time spent on product-related pages in seconds                    |
| BounceRates             | Quantitative | Percentage of visitors leaving after one page                     |
| ExitRates               | Quantitative | Percentage of sessions exiting from each page                     |
| PageValues              | Quantitative | Average value attributed to a page                                |
| SpecialDay              | Quantitative | Metric indicating proximity to significant holidays               |
| Weekend                 | Binary       | Indicates if the session occurred on a weekend (1 = Yes, 0 = No)  |
| Revenue                 | Binary       | Indicates if the session resulted in a purchase (1 = Yes, 0 = No) |
| VisitorType             | Categorical  | Visitor category (e.g., Returning, New, Other)                    |
| Month                   | Categorical  | Month of the visit (e.g., Jan, Feb)                               |
| OperatingSystems        | Categorical  | Visitor operating system (e.g., Windows, MacOS)                   |
| Browser                 | Categorical  | Browser used by the visitor (e.g., Safari, Chrome)                |
| Region                  | Categorical  | Visitor geographical region                                       |
| TrafficType             | Categorical  | Type of traffic source leading to the visit                       |

To obtain this structure a preprocessing step was performed, which included the following transformations:
  - The categorical variables were converted to factors.
  - The target variable (0 for no purchase, 1 for purchase) and the binary variables were converted to a binary format 
  - Name changes were made to some variables for better readability and naming consistency.
  - A random subset of 2,000 observations was selected from the original dataset.


The code to preprocess the dataset is as follows:
```{r, eval = FALSE, echo = TRUE}
set.seed(100)
data <- read_csv(
  paste('../../data/online+shoppers+purchasing+intention+dataset/',
        'online_shoppers_intention.csv', sep = '')
)

data <- data %>%
  mutate(
    Month = as.factor(Month),
    Region = as.factor(Region),
    TrafficType = as.factor(TrafficType),
    VisitorType = as.factor(VisitorType),
    OperatingSystems = as.factor(OperatingSystems),
    Browser = as.factor(Browser),
    Weekend = as.factor(as.numeric(Weekend == 'TRUE')),
    Revenue = as.factor(as.numeric(Revenue == 'TRUE')),
    SpecialDay = as.factor(SpecialDay)
  ) %>%
  rename(
    AdministrativeDuration = Administrative_Duration,
    InformationalDuration = Informational_Duration,
    ProductRelatedDuration = ProductRelated_Duration
  ) %>% 
  sample_n(2000)


```

## 1.3 Data Integrity
We begin by assessing the integrity of the dataset by analyzing the presence of missing data across its features. The table below presents the count of missing values for each feature. As shown, there are **no missing values** in any of the features, which indicates that the dataset is complete and does not require any imputation for missing data.

Additionally, we check for duplicate records in the dataset. The analysis revealed **6 duplicate rows**, which may be due to several factors. These duplicates could represent unintentional repetitions of the same individualâ€™s data, or they could arise from issues during data collection, such as individuals' data being recorded more than once under slightly different conditions. As the amount is relatively small, we will proceed with the analysis without removing these duplicates. 

Given the absence of missing values and the limited number of duplicate rows, the dataset does not require any further cleaning or preprocessing steps before proceeding with our initial analysis.

```{r}
data <- readRDS('../../data/R_datasets/processed_dataset.rds')

# Checking for missing values
missing_values <- sapply(data, function(x) sum(is.na(x)))

# Checking for duplicate rows
duplicate_rows <- sum(duplicated(data))

# Displaying the missing values count
kable(missing_values, caption = "Missing Values Count for Each Feature", align = "c")

# Displaying the number of duplicate rows
cat("Number of duplicate rows:", duplicate_rows)
```
\vspace{0.3cm}

# 2. Univariate Analysis

## 2.1 Numeric Variables

```{r}
# Split numeric and categorical variables
numeric_vars <- data %>% select(where(is.numeric))
categorical_vars <- data %>% select(where(is.factor))
```

### 2.1.1 Time Related Variables

The duration variables (e.g., `AdministrativeDuration`, `InformationalDuration`, `ProductRelatedDuration`) exhibit values for the mean significantly higher than the median, indicating a heavily right-skewed distribution. This suggests that there are a few sessions with very high durations that are pulling the mean upwards. The range of values for these variables is quite large, with the maximum values being several times higher than the 75th percentile. 
```{r, out.width = '100%', out.height = '100%'}
# Summarize numeric variables
numeric_summary <- summary(numeric_vars[, c("AdministrativeDuration", "InformationalDuration", "ProductRelatedDuration")])

# Display the summary aligned to the left
pander(numeric_summary, caption = "Summary of Numeric Time Related Variables", style = "rmarkdown", justify = "left")

```

The boxplots and histograms provide clear evidence of the right-skewed nature of these variables, characterized by a high concentration of values near zero and a long tail of extreme values. This distribution highlights the presence of numerous outliers, which are not isolated anomalies but rather a significant portion of the data. These extreme values likely represent important behavioral patterns or user interactions that could offer valuable insights. Therefore, instead of removing or treating them as noise, we choose to retain these outliers in our analysis to ensure a comprehensive understanding of the dataset and its implications.

```{r, out.height = '100%', out.width = '100%'}
# Set layout for 3 rows and 3 columns (9 plots per page)
par(mfrow = c(3, 2), mar = c(4, 4, 2, 1))  # Adjust margins

# Create histograms for each numeric variable
for (var_name in names(numeric_vars[, c("AdministrativeDuration", "InformationalDuration", "ProductRelatedDuration")])) {
  
  # Histogram
  hist(numeric_vars[[var_name]], 
       main = var_name, 
       xlab = var_name, 
       col = "lightgreen", 
       breaks = 50)
  
  # Boxplot
  boxplot(numeric_vars[[var_name]], 
          main = paste(var_name), 
          ylab = var_name, 
          col = "lightblue", 
          horizontal = TRUE)
}
```

### 2.1.2 Page Interaction Variables

The variables related to page interactions (e.g., `Administrative`, `Informational`, `ProductRelated`) represent the number of pages visited by the user during the session. From all 3 variables, `ProductRelated` has the highest mean and median values while `Informational` and `Administrative` have lower but similar values. The summary statistics also suggest a right-skewed distribution for these variables, with the mean exceeding the median. 
```{r, out.width = '100%', out.height = '100%'}
# Summarize numeric variables
numeric_summary <- summary(numeric_vars[, c("Administrative", "Informational", "ProductRelated")])

# Display the summary aligned to the left
pander(numeric_summary, caption = "Summary of Page Interaction Variables", style = "rmarkdown", justify = "left")

```

The boxplots and histograms for these variables confirm the right-skewed distribution, with a large number of sessions having low page interaction counts and a few sessions with very high counts. While all three variables exhibit similar patterns, the `Informational` variable has a more pronounced skewness, followed by `ProductRelated` and `Administrative`. The presence of outliers in these variables is expected, as user behavior can vary significantly, with some users exploring multiple pages while others may exit quickly after viewing a few pages. We believe this outlier behavior is essential for understanding user engagement and purchase intent and should be retained in the analysis.


```{r, out.height = '100%', out.width = '100%'}
# Set layout for 3 rows and 3 columns (9 plots per page)
par(mfrow = c(3, 2), mar = c(4, 4, 2, 1))  # Adjust margins

# Create histograms for each numeric variable
for (var_name in names(numeric_vars[, c("Administrative", "Informational", "ProductRelated")])) {
  
  # Histogram
  hist(numeric_vars[[var_name]], 
       main = var_name, 
       xlab = var_name, 
       col = "lightgreen", 
       breaks = 50)
  
  # Boxplot
  boxplot(numeric_vars[[var_name]], 
          main = paste(var_name), 
          ylab = var_name, 
          col = "lightblue", 
          horizontal = TRUE)
}
```

### 2.1.3 Other Numeric Variables

The following variables are derived from Google Analytics, providing insights into user behavior on the website:

- **BounceRates**: Represents the percentage of visitors who leave the site after viewing only one page. Summary statistics show values ranging from 0 to 0.2, with a mean of 0.023 and a median of 0.003. The distribution is right-skewed, as the mean is higher than the median, indicating a concentration of low values and a few higher values.

- **ExitRates**: Represents the percentage of visitors who exit the site from a specific page. While the dataset doesn't specify which page this refers to, it may be a critical page or one leading to a purchase. The values range from 0 to 0.2, with a mean of 0.043 and a median of 0.025. Like **BounceRates**, this variable is also right-skewed although not as extreme,  with a concentration of low values and a few higher values.

- **PageValues**: Represents the average value of a page that a user visits before completing a transaction. The values range from 0 to 255, with a mean of 5.89 and a median of 0.0. This variable is heavily right-skewed, indicating that while most pages have little to no assigned value. There are a few pages with high values that significantly impact the mean.


```{r, out.width = '100%', out.height = '100%'}
# Summarize numeric variables
numeric_summary <- summary(numeric_vars[, c("BounceRates", "ExitRates", "PageValues")])

# Display the summary aligned to the left
pander(numeric_summary, caption = "Summary of Page Interaction Variables", style = "rmarkdown", justify = "left")

```
\vspace{0.3cm}

The visualizations for these variables further confirm the right-skewed distribution, with a concentration of low values and a few high values. The histograms and boxplots provide a clear representation of the distribution of these variables, highlighting the presence of outliers and the need to consider these extreme values in the analysis. We've observed outliers in all variables which may suggest specific user behaviors or interactions that could be crucial for understanding purchasing intent and user engagement on the website. As done with other variables, we choose to retain these outliers in our analysis to ensure a comprehensive understanding of the dataset.

\vspace{0.3cm}

```{r, out.height = '100%', out.width = '100%'}
# Set layout for 3 rows and 3 columns (9 plots per page)
par(mfrow = c(3, 2), mar = c(4, 4, 2, 1))  # Adjust margins

# Create histograms for each numeric variable
for (var_name in names(numeric_vars[, c("BounceRates", "ExitRates", "PageValues")])) {
  
  # Histogram
  hist(numeric_vars[[var_name]], 
       main = var_name,, 
       xlab = var_name, 
       col = "lightgreen", 
       breaks = 50)
  
  # Boxplot
  boxplot(numeric_vars[[var_name]], 
          main = paste(var_name), 
          ylab = var_name, 
          col = "lightblue", 
          horizontal = TRUE)
}
```

## 2.2 Categorical Variables

### 2.2.1 Visitor Demographics/Identity

- **VisitorType:**  
  The majority of visitors are **Returning Visitors**, indicating a strong base of repeat users. **New Visitors** form a smaller proportion, and the **Other** category is negligible, suggesting minimal contribution from other visitor types.

- **Region:**  
  Region **1** has the highest count of visitors, followed by Region **3**. Traffic is highly concentrated in these specific regions, with other regions showing a relatively lower number of visitors.


```{r}
# Summarize categorical variables
categorical_summary <- summary(categorical_vars[, c("VisitorType", "Region")])

# Create barplots and store them in a list
plots <- lapply(names(categorical_vars[, c("VisitorType", "Region")]), function(var_name) {
  ggplot(categorical_vars, aes(x = .data[[var_name]])) +
    geom_bar(fill = "lightblue") +
    labs(title = var_name, 
         x = var_name, 
         y = "Count") +
    theme_minimal()
})

# Display plots in a 1x2 grid layout
grid.arrange(grobs = plots, ncol = 2)
```

### 2.2.2 Technical Attributes

- **Browser:**  
  Browser **2** is the most commonly used browser, significantly surpassing others in popularity. Browser **1** has a notable user base, while the other browsers are used by only a small fraction of users.

- **OperatingSystems:**  
  Operating System **2** dominates usage, followed by Operating System **1**. Other operating systems have a minor presence, highlighting user preference for a few dominant operating systems.

```{r}
# Create barplots and store them in a list
plots <- lapply(names(categorical_vars[, c("Browser", "OperatingSystems")]), function(var_name) {
  ggplot(categorical_vars, aes(x = .data[[var_name]])) +
    geom_bar(fill = "lightblue") +
    labs(title = var_name, 
         x = var_name, 
         y = "Count") +
    theme_minimal()
})

# Display plots in a 1x2 grid layout
grid.arrange(grobs = plots, ncol = 2)
```
### 2.2.3 Traffic and Source

- **Month:**  
  Traffic peaks in **March**, **May**, and **November**, with the highest activity in **May**. Lower traffic is observed in **June**, **July**, and **February**, potentially reflecting seasonal trends or business cycles.

- **TrafficType:**  
  TrafficType **2** is the primary source of traffic, with a significant lead over TrafficType **1**. Other TrafficTypes contribute marginally, indicating that a few referral sources or marketing channels drive the majority of traffic.

```{r}
# Create barplots and store them in a list
plots <- lapply(names(categorical_vars[, c("Month", "TrafficType")]), function(var_name) {
  ggplot(categorical_vars, aes(x = .data[[var_name]])) +
    geom_bar(fill = "lightblue") +
    labs(title = var_name, 
         x = var_name, 
         y = "Count") +
    theme_minimal()
})

# Display plots in a 1x2 grid layout
grid.arrange(grobs = plots, ncol = 2)
```
## 2.3 Binary Variables

- **Weekend:**  
  The  binary variable `Weekend` indicates whether the session occurred on a weekend. We observe that around ~23% of the sessions occurred on weekends, while the majority (~77%) took place on weekdays. This distribution suggests that the website receives a higher volume of traffic on weekdays compared to weekends (which also holds if we took the daily average).
  
- **Revenue:**
  The target variable `Revenue` indicates whether a session resulted in a purchase. The dataset is imbalanced, with a higher number of sessions where no purchase (~85%) was made compared to sessions resulting in a purchase (~15%). This imbalance is expected in e-commerce datasets, where the conversion rate is typically lower than the non-conversion rate.

```{r}
# Create barplots and store them in a list
plots <- lapply(names(categorical_vars[, c("Weekend", "Revenue")]), function(var_name) {
  ggplot(categorical_vars, aes(x = .data[[var_name]])) +
    geom_bar(fill = "lightblue") +
    labs(title = var_name, 
         x = var_name, 
         y = "Count") +
    theme_minimal()
})

# Display plots in a 1x2 grid layout
grid.arrange(grobs = plots, ncol = 2)
```

# 3. Multivariate Analysis

```{r}
# Compute the correlation matrix
correlation_matrix <- cor(numeric_vars)

correlation_melted <- melt(correlation_matrix)

# Heatmap of the correlation matrix with values
ggplot(correlation_melted, aes(Var1, Var2, fill = value)) +
  geom_tile() +  # Create the heatmap tiles
  geom_text(aes(label = round(value, 2)), color = "black", size = 3) +  # Add the correlation values inside the tiles
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1, 1)) +  # Color scale
  labs(title = "Correlation Matrix Heatmap", x = "Variables", y = "Variables") +  # Title and labels
  theme_minimal() +  # Clean theme
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-ax

```

```{r}
# PCA with R built in function
pca <- prcomp(numeric_vars, center = TRUE, scale. = TRUE)
pca$rotation
```

```{r}
# PCA step by step

eig_result <- eigen(correlation_matrix)

# Get the eigenvalues and eigenvectors
Lambda <- eig_result$values  # Eigenvalues
T <- eig_result$vectors      # Eigenvectors

# Sort eigenvalues and eigenvectors in descending order
sorted_indices <- order(Lambda, decreasing = TRUE)  # Indices for sorting

# Apply the sorting
Lambda_sorted <- Lambda[sorted_indices]  # Sorted eigenvalues
T_sorted <- T[, sorted_indices]          # Sorted eigenvectors

# Show the sorted eigenvalues
Lambda_sorted

# Show the eigenvectors
T_sorted



```



# 5. References

- UCI Machine Learning Repository. (n.d.). **Online Shoppers Purchasing Intention Dataset**. Retrieved from [https://archive.ics.uci.edu/dataset/468/online+shoppers+purchasing+intention+dataset](https://archive.ics.uci.edu/dataset/468/online+shoppers+purchasing+intention+dataset).
